#Create an array containing the list of servers to be updated:
$Servers = Get-Content C:\TEMP\MP_jump.txt

# Create the variable to hold the credentials:
$Credentials = Get-Credential

# Iterate through the array created above:
foreach ($server in $Servers) {

Invoke-Command -Credential $Credentials -ComputerName $server -ScriptBlock {
	# Write to the screen so that the user knows which server is being worked on:
	Write-Host " "
	Write-Host "Now working on $using:server"
	# Check for presence of 1st registry entry & notify user:
if (Test-Path 'Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Wintrust\Config') {
	Write-Host "FIRST registry key found..."
	# Back up 1st registry entry & notify user:
	reg export 'Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Wintrust\Config' C:\CVE-2013-3900-1.reg
	$FileName = "C:\CVE-2013-3900-1.reg"
	if (Test-Path $FileName) {
		Write-Host "Backup of FIRST registry key was successful."
	}
  }
	# Check for presence of second registry entry & notify user:	
	elseif (Test-Path 'Registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config') {
	Write-Host "SECOND registry key found..."
	# Back up 2nd registry entry & notify user:
	reg export 'Registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config' C:\CVE-2013-3900-2.reg
	$FileName = "C:\CVE-2013-3900-2.reg"
	if (Test-Path $FileName) {
		Write-Host "Backup of SECOND registry key was successful."
	}
  }
	else {
		Write-Host "NEITHER registry key was found."
	}	
	# If the first registry key doesn't exist, create it, & notify the user:
if (!(Test-Path -Path Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Wintrust\Config)) {
	New-Item -Path Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Wintrust\Config -Force
	Set-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Wintrust\Config -Name EnableCertPaddingCheck -Value 1 -Type String
	# Set-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Wintrust\Config -Name EnableCertPaddingCheck -Value 1 -Type REG_SZ
    Write-Host "First registry key created."
	}
	# If the second registry key doesn't exist, create it, & notify the user:	
if (!(Test-Path -Path Registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config)) {
	New-Item -Path Registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config -Force
	Set-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config -Name EnableCertPaddingCheck -Value 1 -Type String
	# Set-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config -Name EnableCertPaddingCheck -Value 1 -Type REG_SZ	
    Write-Host "Second registry key created."
	# Output a bit of "visual separation" between systems to make the output somewhat more readable:
	Write-Host " "
	Write-Host "======================================================================================"
	Write-Host " "
    }
  }
}
